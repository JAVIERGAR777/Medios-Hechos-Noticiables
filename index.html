<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Diario de Eventos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .date-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        #date-picker {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            opacity: 0.92;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.12);
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .btn-home {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 8px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background-color: #e2e8f0;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab-btn:hover {
            background-color: #cbd5e1;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .stat-label {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }
        
        .event-type-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .event-type-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s ease;
        }
        
        .event-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .event-type-number {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .event-type-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
        }
        
        .map-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            height: 500px;
            position: relative;
        }
        
        #map {
            height: 100%;
            border-radius: 6px;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
        }
        
        .legend h3 {
            margin-bottom: 12px;
            color: #1e293b;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f8fafc;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .table-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }
        
        tr:hover {
            background-color: #f8fafc;
        }
        
        .btn-link {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            min-width: 100px;
        }
        
        .btn-link:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1rem;
            color: #64748b;
        }
        
        .error {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            color: #dc2626;
            background-color: #fef2f2;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: #64748b;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .event-type-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-selector {
                width: 100%;
                justify-content: center;
            }
            
            .map-container {
                height: 400px;
            }
            
            .btn-link {
                padding: 10px 18px;
                min-width: 120px;
                font-size: 0.9rem;
            }
            
            .btn-container {
                display: flex;
                gap: 8px;
                justify-content: center;
                width: 100%;
                margin-top: 10px;
            }
        }

        .pdf-notice {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            background: #16a34a;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 0.9rem;
            font-weight: 600;
            animation: fadeIn 0.4s, fadeOut 0.4s 2s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-15px); }
        }

        .high-visibility-marker {
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.7));
        }
        
        .btn-container {
            display: flex;
            gap: 8px;
        }

        .map-number-label {
            position: absolute;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8), 
                         -1px -1px 3px rgba(0, 0, 0, 0.8),
                         1px -1px 3px rgba(0, 0, 0, 0.8),
                         -1px 1px 3px rgba(0, 0, 0, 0.8);
            font-size: 14px;
            font-weight: 900;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -50%);
        }
        
        .custom-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            border: 2px solid #000;
            border-radius: 50%;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Reporte Diario de Medios y Victimología</h1>
        </header>
        
        <div class="controls-container">
            <div class="date-selector">
                <label for="date-picker" style="font-weight: 600; font-size: 0.9rem;">Fecha:</label>
                <input type="date" id="date-picker">
                <button class="btn" id="generate-btn">Generar</button>
            </div>
            <div class="btn-container">
                <button class="btn btn-home" id="home-btn">Volver a Inicio</button>
                <button class="btn btn-pdf" id="pdf-btn">Exportar PDF</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" id="daily-btn">Reporte Diario de Medios y Victimología</button>
            <button class="tab-btn" id="weekly-btn">Reporte Quincenal</button>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="total-events">0</div>
                <div class="stat-label">EVENTOS TOTALES</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-victims">0</div>
                <div class="stat-label">VÍCTIMAS TOTALES</div>
            </div>
        </div>
        
        <div class="event-type-container" id="event-type-cards">
            <!-- Los contadores por tipo de evento se insertarán aquí mediante JavaScript -->
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="legend">
            <h3>Leyenda de Tipos de Eventos</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Entradera</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Robo de Pertenencias</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>Robo Vehícular</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Incendio</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>Escruche</span>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h2 id="table-title" style="font-size: 1.2rem; margin-bottom: 12px; color: #1e293b; text-align: center;">Eventos del Día</h2>
            <div class="loading" id="loading-indicator">Cargando datos desde SheetBest...</div>
            <table>
                <thead>
                    <tr>
                        <th>Nº</th>
                        <th>Fecha</th>
                        <th>Tipología</th>
                        <th>Momento</th>
                        <th>Entorno</th>
                        <th>Descripción</th>
                        <th>Víctimas</th>
                        <th>Medio</th>
                        <th>Cobertura</th>
                        <th>Enlace</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <!-- Los datos se insertarán aquí mediante JavaScript -->
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>Plataforma de Visualización de Eventos &copy; 2025</p>
        </footer>

        <div class="pdf-notice" id="pdf-notice">
            ¡PDF generado con éxito!
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // URL de la API de Sheetbest
        const SHEETBEST_URL = 'https://api.sheetbest.com/sheets/63d0e8d5-5d04-468f-baea-a951c8d5c55a';
        
        // Colores para los diferentes tipos de eventos
        const eventColors = {
            "Entradera": "#e74c3c",
            "Robo de Pertenencias": "#3498db",
            "Robo Vehícular": "#2ecc71",
            "Incendio": "#f39c12",
            "Escruche": "#9b59b6"
        };

        // Variables globales
        let map;
        let allEventsData = [];
        let currentDate = '';
        let mapMarkers = [];
        let filteredEvents = [];
        
        // Inicializar el mapa
        function initMap() {
            map = L.map('map').setView([-34.921, -57.955], 12);
            
            // Añadir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
        
        // Mostrar mensaje de error
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Ocultar mensaje de error
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Mostrar notificación de PDF
        function showPdfNotice() {
            const notice = document.getElementById('pdf-notice');
            notice.style.display = 'block';
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                notice.style.display = 'none';
            }, 3000);
        }
        
        // Cargar datos desde Sheetbest
        async function loadData() {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                hideError();
                
                console.log('Cargando datos desde:', SHEETBEST_URL);
                const response = await fetch(SHEETBEST_URL);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                if (!Array.isArray(data)) {
                    throw new Error('Formato de datos inesperado. Se esperaba un array.');
                }
                
                allEventsData = data.map(item => {
                    return {
                        coordenadas: item['Pegar Coordenadas'] || '',
                        fecha: item['Fecha'] || '',
                        tipologia: item['Tipología del Evento'] || '',
                        momento: item['Momento del Dia del Hecho'] || '',
                        entorno: item['Entorno en que ocurre el evento'] || '',
                        descripcion: item['Breve Descripción del Evento'] || '',
                        victimas: item['Cantidad de Victimas ( solo indicar en número)'] || 0,
                        enlace: item['Link de Nota'] || '',
                        titulo: item['Titulo del Evento'] || 'Sin título', // Corregido: sin acento
                        medio: item['Medio'] || 'Medio no especificado',
                        cobertura: item['Número de medios que cubrieron la noticia'] || '1'
                    };
                }).filter(item => item.fecha); 
                
                console.log('Datos procesados:', allEventsData);
                
                if (allEventsData.length > 0) {
                    const latestDate = findLatestDate(allEventsData);
                    document.getElementById('date-picker').value = convertToInputDateFormat(latestDate);
                    
                    processDataForDate(latestDate);
                }
                
                document.getElementById('loading-indicator').style.display = 'none';
            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                showError(`Error al cargar datos: ${error.message}. Verifica la consola para más detalles.`);
            }
        }
        
        function findLatestDate(events) {
            let latestDate = '';
            let latestTime = 0;
            
            events.forEach(event => {
                if (event.fecha) {
                    const parts = event.fecha.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        const timestamp = date.getTime();
                        
                        if (timestamp > latestTime) {
                            latestTime = timestamp;
                            latestDate = event.fecha;
                        }
                    }
                }
            });
            
            return latestDate || (events.length > 0 ? events[0].fecha : '');
        }
        
        function convertToInputDateFormat(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return '';
        }
        
        function convertToSheetDateFormat(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${day}/${month}/${year}`;
            }
            return '';
        }
        
        function processDataForDate(dateStr) {
            currentDate = dateStr;
            console.log('Procesando datos para fecha:', dateStr);
            
            filteredEvents = allEventsData.filter(event => {
                return event.fecha === dateStr;
            });
            
            console.log('Eventos filtrados:', filteredEvents);
            
            document.getElementById('total-events').textContent = filteredEvents.length;
            
            const totalVictims = filteredEvents.reduce((sum, event) => {
                const victimCount = parseVictimCount(event.victimas);
                return sum + victimCount;
            }, 0);
            
            document.getElementById('total-victims').textContent = totalVictims;
            
            updateEventTypeCounters(filteredEvents);
            
            document.getElementById('table-title').textContent = `Eventos del Día (${dateStr})`;
            
            clearMap();
            
            let hasValidCoordinates = false;
            mapMarkers = [];
            
            filteredEvents.forEach((event, index) => {
                if (event.coordenadas) {
                    try {
                        const coords = event.coordenadas.split(',').map(coord => {
                            return parseFloat(coord.trim().replace(/[^\d.-]/g, ''));
                        });
                        
                        if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                            const [lat, lng] = coords;
                            const eventType = event.tipologia || 'Desconocido';
                            const color = eventColors[eventType] || '#7f8c8d';
                            
                            // Crear marcador personalizado con número integrado
                            const markerHtml = `
                                <div class="custom-marker" style="background-color: ${color};">
                                    ${index + 1}
                                </div>
                            `;
                            
                            const icon = L.divIcon({
                                className: 'custom-marker-container',
                                html: markerHtml,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            const marker = L.marker([lat, lng], {icon: icon}).addTo(map);
                            
                            // Popup mejorado
                            marker.bindPopup(`
                                <div style="max-width: 250px; font-size: 0.9rem;">
                                    <strong style="color: ${color}; font-size: 1.1rem;">${eventType}</strong><br>
                                    <strong>#${index + 1}:</strong> ${event.titulo || 'Sin título'}<br>
                                    <strong>Fecha:</strong> ${event.fecha}<br>
                                    <strong>Momento:</strong> ${event.momento}<br>
                                    <strong>Entorno:</strong> ${event.entorno}<br>
                                    <strong>Descripción:</strong> ${event.descripcion || 'Sin descripción'}<br>
                                    <strong>Víctimas:</strong> ${parseVictimCount(event.victimas)}<br>
                                    <strong>Medio:</strong> ${event.medio || 'Medio no especificado'}<br>
                                    <strong>Cobertura:</strong> ${event.cobertura || '1'} medio(s)<br>
                                    ${event.enlace ? `<a href="${event.enlace}" target="_blank" class="btn-link">Ver noticia</a>` : ''}
                                </div>
                            `);
                            
                            mapMarkers.push(marker);
                            hasValidCoordinates = true;
                        }
                    } catch (e) {
                        console.error('Error procesando coordenadas:', event.coordenadas, e);
                    }
                }
            });
            
            if (hasValidCoordinates && mapMarkers.length > 0) {
                const markerGroup = new L.featureGroup(mapMarkers);
                const bounds = markerGroup.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([-34.921, -57.955], 12);
                console.warn('No se encontraron coordenadas válidas para los eventos');
            }
            
            const tableBody = document.getElementById('events-table-body');
            tableBody.innerHTML = '';
            
            if (filteredEvents.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center;">No hay eventos para esta fecha</td>`;
                tableBody.appendChild(row);
            } else {
                filteredEvents.forEach((event, index) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><strong>${index + 1}</strong></td>
                        <td>${event.fecha || ''}</td>
                        <td>${event.tipologia || ''}</td>
                        <td>${event.momento || ''}</td>
                        <td>${event.entorno || ''}</td>
                        <td>${event.descripcion || ''}</td>
                        <td>${parseVictimCount(event.victimas)}</td>
                        <td>${event.medio || ''}</td>
                        <td>${event.cobertura || '1'}</td>
                        <td>${event.enlace ? `<a href="${event.enlace}" target="_blank" class="btn-link">Ver noticia</a>` : 'N/A'}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
        }
        
        function clearMap() {
            mapMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            mapMarkers = [];
        }
        
        function updateEventTypeCounters(events) {
            const eventTypeContainer = document.getElementById('event-type-cards');
            eventTypeContainer.innerHTML = '';
            
            const eventCounts = {};
            events.forEach(event => {
                const eventType = event.tipologia || 'Desconocido';
                eventCounts[eventType] = (eventCounts[eventType] || 0) + 1;
            });
            
            Object.entries(eventCounts).forEach(([eventType, count]) => {
                const color = eventColors[eventType] || '#7f8c8d';
                
                const card = document.createElement('div');
                card.className = 'event-type-card';
                card.style.borderLeftColor = color;
                
                card.innerHTML = `
                    <div class="event-type-number">${count}</div>
                    <div class="event-type-label">${eventType.toUpperCase()}</div>
                `;
                
                eventTypeContainer.appendChild(card);
            });
            
            if (Object.keys(eventCounts).length === 0) {
                eventTypeContainer.innerHTML = '<div class="event-type-card" style="grid-column: 1 / -1; text-align: center;">No hay eventos registrados</div>';
            }
        }
        
        function parseVictimCount(victimCount) {
            if (!victimCount && victimCount !== 0) return 0;
            
            if (typeof victimCount === 'string') {
                if (victimCount.includes('+')) {
                    return parseInt(victimCount.replace(/\D/g, '')) || 0;
                }
            }
            
            const parsed = parseInt(victimCount);
            return isNaN(parsed) ? 0 : parsed;
        }
        
        // Función para formatear la fecha en español
        function formatDateToSpanish(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parts[2];
                
                const monthNames = [
                    "enero", "febrero", "marzo", "abril", "mayo", "junio",
                    "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
                ];
                
                return `${day} de ${monthNames[month - 1]} de ${year}`;
            }
            return dateStr;
        }
        
        // Función para obtener la hora actual formateada
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Función para dibujar un logo simple en el PDF
        function drawLogo(pdf, x, y, width, height) {
            // Dibujar un rectángulo con el color de fondo
            pdf.setFillColor(0, 88, 94); // #00585e
            pdf.rect(x, y, width, height, 'F');
            
            // Dibujar texto dentro del logo
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            pdf.text("LOGO", x + width/2, y + height/2, { align: 'center', baseline: 'middle' });
        }
        
        // Función para capturar el mapa como imagen
        async function captureMap() {
            try {
                const mapContainer = document.getElementById('map');
                const canvas = await html2canvas(mapContainer, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    scale: 2, // Mayor calidad para el PDF
                    logging: false
                });
                
                return canvas.toDataURL('image/png', 1.0); // Máxima calidad
            } catch (error) {
                console.error('Error capturando el mapa:', error);
                return null;
            }
        }
        
        async function generatePDF() {
            try {
                const pdfBtn = document.getElementById('pdf-btn');
                const originalText = pdfBtn.textContent;
                pdfBtn.textContent = 'Generando...';
                pdfBtn.disabled = true;
                
                // Obtener eventos para la fecha actual
                const eventsForDate = allEventsData.filter(event => event.fecha === currentDate);
                
                // Capturar el mapa como imagen
                const mapImage = await captureMap();
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Configurar estilos
                const titleFontSize = 16;
                const headerFontSize = 14;
                const normalFontSize = 12;
                const smallFontSize = 10;
                
                // Dibujar logo en lugar de usar una imagen
                drawLogo(pdf, 15, 15, 30, 18);
                
                // Línea delgada azul superior
                pdf.setDrawColor(0, 174, 195); // #00aec3
                pdf.setLineWidth(0.5);
                pdf.line(15, 35, 195, 35);
                
                // Títulos - ALINEADOS A LA IZQUIERDA
                pdf.setFontSize(headerFontSize);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0, 174, 195); // #00aec3 (color celeste)
                pdf.text("SECRETARÍA DE SEGURIDAD", 15, 42);
                
                pdf.setFontSize(18);
                pdf.setTextColor(0, 88, 94); // #00585e (color verde oscuro)
                // Dividir "RELEVAMIENTO DE MEDIOS" en dos líneas
                pdf.text("RELEVAMIENTO DE", 15, 50);
                pdf.text("MEDIOS", 15, 58);
                
                // Segunda línea delgada azul inferior
                pdf.setDrawColor(0, 174, 195); // #00aec3
                pdf.line(15, 62, 195, 62);
                
                // Fechas y horas
                pdf.setFontSize(normalFontSize);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(0, 0, 0);
                const formattedDate = formatDateToSpanish(currentDate);
                const currentTime = getCurrentTime();
                
                pdf.text(`DESDE: ${formattedDate} ${currentTime}`, 20, 75);
                pdf.text(`HASTA: ${formattedDate} ${currentTime}`, 20, 85);
                
                // Hechos registrados
                pdf.setFont(undefined, 'bold');
                pdf.text(`HECHOS REGISTRADOS: ${eventsForDate.length}`, 20, 100);
                pdf.text(`NOTICIAS TOTALES: ${eventsForDate.length}`, 20, 110);
                
                // Espacio antes de los detalles
                let yPosition = 125;
                
                // Detalles de cada noticia
                pdf.setFontSize(headerFontSize);
                pdf.setFont(undefined, 'bold');
                
                // Primero procesamos todas las noticias
                eventsForDate.forEach((event, index) => {
                    // Comprobar si necesitamos una nueva página (dejamos más margen)
                    if (yPosition > 240) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    // Número de noticia
                    pdf.text(`#${index + 1}`, 20, yPosition);
                    yPosition += 7;
                    
                    // Resumen
                    pdf.setFontSize(normalFontSize);
                    pdf.setFont(undefined, 'normal');
                    const descripcion = event.descripcion || 'Sin descripción';
                    const splitDesc = pdf.splitTextToSize(`Resumen: ${descripcion}`, 170);
                    
                    // Verificar si hay espacio suficiente para el resumen
                    const espacioNecesario = splitDesc.length * 6 + 5;
                    if (yPosition + espacioNecesario > 270) {
                        pdf.addPage();
                        yPosition = 20;
                        pdf.setFontSize(headerFontSize);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`#${index + 1}`, 20, yPosition);
                        yPosition += 7;
                        pdf.setFontSize(normalFontSize);
                        pdf.setFont(undefined, 'normal');
                    }
                    
                    pdf.text(splitDesc, 20, yPosition);
                    yPosition += espacioNecesario;
                    
                    // Título
                    const titulo = event.titulo || 'Sin título';
                    const splitTitulo = pdf.splitTextToSize(`Título: ${titulo}`, 170);
                    
                    // Verificar espacio para el título
                    if (yPosition + 15 > 270) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.text(splitTitulo, 20, yPosition);
                    yPosition += splitTitulo.length * 6 + 2;
                    
                    // Medio
                    const medio = event.medio || 'Medio no especificado';
                    const splitMedio = pdf.splitTextToSize(`Medio: ${medio}`, 170);
                    
                    // Verificar espacio para el medio
                    if (yPosition + 15 > 270) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.text(splitMedio, 20, yPosition);
                    yPosition += splitMedio.length * 6 + 2;
                    
                    // Cobertura (número de medios que cubrieron la noticia)
                    const cobertura = event.cobertura || '1';
                    
                    // Verificar espacio para la cobertura
                    if (yPosition + 10 > 270) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.text(`Cobertura: ${cobertura} medio(s)`, 20, yPosition);
                    yPosition += 7;
                    
                    // Link (azul y subrayado)
                    pdf.setTextColor(0, 0, 255);
                    
                    // Verificar espacio para el link
                    if (yPosition + 10 > 270) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.textWithLink('Link: Ver noticia', 20, yPosition, { url: event.enlace });
                    pdf.setTextColor(0, 0, 0);
                    yPosition += 10;
                    
                    // Espacio entre noticias
                    yPosition += 5;
                    
                    // Volver a establecer estilo de título para la próxima noticia
                    pdf.setFontSize(headerFontSize);
                    pdf.setFont(undefined, 'bold');
                });
                
                // Agregar el mapa al final del PDF si está disponible
                if (mapImage) {
                    pdf.addPage();
                    pdf.setFontSize(headerFontSize);
                    pdf.setFont(undefined, 'bold');
                    pdf.text("MAPA DE EVENTOS - REFERENCIA NUMERADA", 105, 15, { align: 'center' });
                    
                    // Agregar la imagen del mapa (más grande y centrada)
                    pdf.addImage(mapImage, 'PNG', 10, 25, 190, 140);
                    
                    // Agregar leyenda
                    pdf.setFontSize(normalFontSize);
                    pdf.setFont(undefined, 'normal');
                    pdf.text("Leyenda:", 15, 170);
                    
                    let legendY = 180;
                    Object.entries(eventColors).forEach(([eventType, color]) => {
                        pdf.setFillColor(parseInt(color.substring(1, 3), 16), 
                                        parseInt(color.substring(3, 5), 16), 
                                        parseInt(color.substring(5, 7), 16));
                        pdf.rect(15, legendY, 5, 5, 'F');
                        pdf.text(eventType, 22, legendY + 4);
                        legendY += 8;
                    });
                    
                    pdf.setFont(undefined, 'bold');
                    pdf.text("Referencia numérica:", 15, legendY + 10);
                    pdf.setFont(undefined, 'normal');
                    
                    let refY = legendY + 20;
                    const eventsPerColumn = 10;
                    const columnWidth = 85;
                    
                    eventsForDate.forEach((event, index) => {
                        if (event.coordenadas) {
                            const column = Math.floor(index / eventsPerColumn);
                            const xPosition = 15 + (column * columnWidth);
                            
                            if (refY > 270 && column === 0) {
                                // crea una nueva columna en el caso de quedarnos sin espacio
                                refY = legendY + 20;
                            }
                            
                            if (refY <= 270) {
                                pdf.text(`#${index + 1}: ${event.tipologia || 'Sin tipología'}`, xPosition, refY);
                                refY += 7;
                            }
                        }
                    });
                }
                
                // p.  Guardar el PDF
                pdf.save(`relevamiento-medios-${currentDate.replace(/\//g, '-')}.pdf`);
                
                pdfBtn.textContent = originalText;
                pdfBtn.disabled = false;
                
                showPdfNotice();
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                
                const pdfBtn = document.getElementById('pdf-btn');
                pdfBtn.textContent = 'Exportar PDF';
                pdfBtn.disabled = false;
                
                showError('Error al generar el PDF. Por favor, inténtalo de nuevo.');
            }
        }
        
        // Función para redirigir a la página de inicio
        function goToHomePage() {
            window.location.href = 'https://medios-ultversion.netlify.app/';
        }
        
        document.getElementById('generate-btn').addEventListener('click', () => {
            const selectedDateInput = document.getElementById('date-picker').value;
            if (selectedDateInput) {
                const selectedDate = convertToSheetDateFormat(selectedDateInput);
                processDataForDate(selectedDate);
            }
        });
        
        document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        
        document.getElementById('home-btn').addEventListener('click', goToHomePage);
        
        document.getElementById('weekly-btn').addEventListener('click', () => {
            alert('La funcionalidad de reporte quincenal estará disponible próximamente.');
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
        });
    </script>
</body>
</html>
